<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜µì…˜ & ì½”ë“œ ë§ˆìŠ¤í„° (ìŠ¤ë§ˆíŠ¸ íŒŒì‹±)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    /* --- ìŠ¤íƒ€ì¼ ì„¤ì • --- */
    :root {
      --primary: #3b82f6; --primary-hover: #2563eb;
      --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0;
      --text: #1e293b; --text-sub: #64748b;
      --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --purple: #8b5cf6;
      --linked-bg: #eff6ff; --linked-border: #3b82f6;
    }
    body {
      font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); color: var(--text);
      margin: 0; padding: 20px; display: flex; justify-content: center; height: 100vh; box-sizing: border-box;
    }
    .container {
      width: 1600px; max-width: 98vw; background: var(--card); border-radius: 16px;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 95vh;
    }
    
    /* í—¤ë” */
    .header {
      padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff;
    }
    .header h1 { margin: 0; font-size: 20px; font-weight: 800; color: #0f172a; }
    .header p { margin: 4px 0 0; font-size: 13px; color: var(--text-sub); }

    /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
    .controls {
      padding: 14px 24px; background: #f1f5f9; border-bottom: 1px solid var(--border);
      display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;
    }
    .input-group { display: flex; flex-direction: column; gap: 4px; }
    .input-group label { font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }
    
    .file-label {
      background: #fff; border: 1px solid #cbd5e1; padding: 8px 12px; border-radius: 6px;
      font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; transition: 0.2s; min-width: 200px;
    }
    .file-label:hover { border-color: var(--primary); color: var(--primary); }
    input[type="file"] { display: none; }
    
    input[type="text"] {
      padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; outline: none;
    }
    input[type="text"]:focus { border-color: var(--primary); }

    /* ë²„íŠ¼ */
    .btn {
      padding: 8px 14px; border-radius: 6px; font-size: 13px; font-weight: 700; border: none; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-success { background: var(--success); color: #fff; box-shadow: 0 2px 4px rgba(16,185,129,0.2); }
    .btn-success:hover:not(:disabled) { background: #059669; transform: translateY(-1px); }
    .btn-danger { background: #fee2e2; color: var(--danger); }
    .btn-danger:hover { background: #fecaca; }
    .btn-dark { background: #334155; color: #fff; }
    .btn-dark:hover { background: #1e293b; }
    .btn-outline { background: #fff; border: 1px solid #cbd5e1; color: #475569; }
    .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none; }

    /* íˆ´ë°” */
    .toolbar {
      padding: 10px 24px; background: #fff; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center;
    }
    .divider { width: 1px; height: 20px; background: #e2e8f0; margin: 0 4px; }
    .seq-control-box {
      display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: #e0f2fe; border-radius: 6px; border: 1px solid #bae6fd;
    }
    .seq-check { display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 13px; color: #0369a1; cursor: pointer; margin: 0; }
    
    /* í†µê³„ë°” */
    .stats-bar {
      padding: 8px 24px; background: #f8fafc; border-bottom: 1px solid var(--border);
      font-size: 12px; display: flex; gap: 16px; color: var(--text-sub);
    }
    .stat-item b { font-weight: 800; margin-left: 3px; }

    /* í…Œì´ë¸” */
    .table-area { flex: 1; overflow-y: auto; position: relative; background: #fff; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
    thead th {
      position: sticky; top: 0; background: #f8fafc; z-index: 10; padding: 10px 12px;
      text-align: left; color: var(--text-sub); font-weight: 600; border-bottom: 1px solid var(--border);
    }
    tbody td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: var(--text); }
    
    /* í–‰ ìŠ¤íƒ€ì¼ */
    tr { transition: background 0.1s; }
    tr:hover { background: #f8fafc; }
    tr.linked { background-color: var(--linked-bg); }
    tr.linked td:first-child { box-shadow: inset 3px 0 0 var(--linked-border); }
    tr.dragging { opacity: 0.5; background: #e0e7ff; }
    tr.drag-over { border-top: 2px solid var(--primary); }

    /* ì¸í’‹ ìŠ¤íƒ€ì¼ */
    .common-input {
      width: 100%; padding: 8px; border: 1px solid transparent; border-radius: 4px;
      font-family: 'Pretendard', sans-serif; font-size: 13px; background: transparent; transition: 0.2s; box-sizing: border-box;
    }
    .common-input:hover { border-color: #cbd5e1; background: #fff; }
    .common-input:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
    
    .code-input { font-family: 'Monaco', monospace; border: 1px solid #e2e8f0; background: #fff; }
    .code-input.empty { border-color: var(--danger); background: #fef2f2; }
    .code-input.short { border-color: var(--warning); background: #fffbeb; }
    .code-input.auto-code { border-color: var(--purple); background: #f5f3ff; color: #5b21b6; font-weight: 600; }
    .code-input.auto-name { border-color: var(--success); background: #f0fdf4; color: #065f46; font-weight: 600; }

    /* ìš”ì†Œë“¤ */
    .code-input-group { display: flex; gap: 4px; width: 100%; align-items: center; }
    .btn-no-match {
      padding: 0 6px; height: 34px; font-size: 11px; font-weight: 700; 
      border: 1px solid #cbd5e1; background: #fff; color: #94a3b8;
      border-radius: 4px; cursor: pointer; white-space: nowrap;
    }
    .btn-no-match:hover { color: #64748b; background: #f1f5f9; }
    .btn-no-match.active { background: #fee2e2; color: var(--danger); border-color: #fca5a5; }

    .badge { padding: 2px 6px; border-radius: 12px; font-size: 10px; font-weight: 700; display: inline-block; min-width: 40px; text-align:center; }
    .badge-err { background: #fee2e2; color: var(--danger); }
    .badge-warn { background: #fef3c7; color: #d97706; }
    .badge-ok { background: #f1f5f9; color: var(--text-sub); }
    .badge-code { background: #ede9fe; color: var(--purple); }
    .badge-name { background: #dcfce7; color: var(--success); }

    .btn-view-opt {
      font-size: 11px; padding: 4px 8px; background: #f1f5f9; border: 1px solid #cbd5e1;
      border-radius: 4px; color: #64748b; cursor: pointer; width: 100%; margin-right: 4px;
    }
    .btn-view-opt:hover { background: #e2e8f0; color: #1e293b; }

    /* ìƒ‰ìƒë¶„ë¦¬ ë²„íŠ¼ */
    .btn-split {
        font-size: 11px; padding: 4px 8px; background: #f0fdf4; border: 1px solid #86efac;
        border-radius: 4px; color: #166534; cursor: pointer; white-space: nowrap;
    }
    .btn-split:hover { background: #dcfce7; }

    /* ì»¬ëŸ¼ ë„ˆë¹„ */
    .col-chk    { width: 30px; text-align: center; }
    .col-drag   { width: 30px; text-align: center; cursor: grab; color: #cbd5e1; }
    .col-seq    { width: 60px; text-align: center; font-weight: 700; color: #64748b; }
    .col-status { width: 80px; text-align: center; }
    .col-name   { width: 25%; }
    .col-old    { width: 10%; color: #94a3b8; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-code   { width: 30%; }
    .col-info   { width: 120px; text-align: center; white-space: nowrap; }

    input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary); }
    .link-icon { color: #cbd5e1; font-size: 14px; margin-right: 4px; width: 14px; display: inline-block; }
    .link-icon.active { color: var(--primary); font-weight: bold; }

    /* ëª¨ë‹¬ ë“± ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: #fff; width: 800px; max-width: 95vw; height: 80vh; border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; }
    .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 16px; font-weight: 800; }
    .modal-close { cursor: pointer; font-size: 20px; color: #94a3b8; }
    .modal-body { flex: 1; display: flex; flex-direction: column; background: #f8fafc; overflow: hidden; }
    
    .github-section { margin: 16px 24px; padding: 12px; background: #fff; border: 1px solid var(--border); border-radius: 8px; }
    .gh-inputs { display: flex; gap: 8px; margin-bottom: 8px; }
    .gh-input { flex: 1; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px; }
    
    .tabs { display: flex; gap: 4px; padding: 0 24px; border-bottom: 1px solid var(--border); }
    .tab { padding: 8px 16px; font-size: 13px; font-weight: 600; color: var(--text-sub); cursor: pointer; border-radius: 6px 6px 0 0; }
    .tab.active { background: #fff; color: var(--primary); border: 1px solid var(--border); border-bottom: 1px solid #fff; margin-bottom: -1px; }
    
    .rule-list { flex: 1; overflow-y: auto; padding: 0 24px 24px; background: #fff; }
    .rule-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9; gap: 10px; }
    .rule-key { flex: 1; font-size: 12px; font-weight: 500; }
    .rule-val-input { flex: 1; padding: 6px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px; font-family: monospace; }
    .rule-del { padding: 4px 8px; background: #fee2e2; color: #ef4444; border-radius: 4px; font-size: 11px; cursor: pointer; }

    .opt-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .opt-table th { background: #f1f5f9; padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    .opt-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; }

    #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 3000; left: 50%; transform: translateX(-50%); bottom: 30px; font-size: 14px; opacity: 0; transition: 0.3s; }
    #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div>
      <h1>ğŸ”¢ ì˜µì…˜ & ì½”ë“œ ë§ˆìŠ¤í„° (Final)</h1>
      <p>ì…ë ¥ ìµœì í™” + ìƒ‰ìƒ ìë™ë¶„ë¦¬ + ìˆœë²ˆì œì–´ + í´ë¼ìš°ë“œ</p>
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn btn-primary" onclick="openRuleManager()">âš™ï¸ ê·œì¹™/ë™ê¸°í™”</button>
      <button class="btn btn-danger" onclick="resetAll()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="controls">
    <div class="input-group">
      <label>íŒŒì¼ ì„ íƒ</label>
      <label class="file-label">
        <span id="fileName">ğŸ“‚ ì—‘ì…€ íŒŒì¼ ì—´ê¸°</span>
        <input type="file" id="fileInput" accept=".xls,.xlsx" onchange="handleFile(this)">
      </label>
    </div>
    
    <div style="flex:1;"></div>
    
    <button class="btn btn-dark" onclick="downloadOverwrite()" disabled id="btnSave1" title="ì—‘ì…€íŒŒì¼ì„ ë‹«ê³  ëˆ„ë¥´ì„¸ìš”">ğŸ’¾ ë®ì–´ì“°ê¸° ì €ì¥</button>
    <button class="btn btn-success" onclick="downloadNew()" disabled id="btnSave2">ğŸ“¥ ìƒˆ íŒŒì¼ë¡œ ì €ì¥</button>
  </div>

  <div class="toolbar">
    <div class="seq-control-box">
      <label class="seq-check">
        <input type="checkbox" id="useSeq" onchange="toggleSeqMode()">
        ìˆœë²ˆ ì •ë ¬ ì ìš©
      </label>
      <input type="text" id="formatStr" value="00) " placeholder="ì„œì‹" style="width:60px; padding:4px 8px; border:1px solid #bae6fd; border-radius:4px; font-size:12px; display:none;" oninput="recalcNumbers()">
    </div>

    <div class="divider"></div>

    <button class="btn btn-outline" onclick="groupSelected()">ğŸ”— ì„ íƒ ë¬¶ê¸°</button>
    <button class="btn btn-outline" onclick="ungroupSelected()">ğŸ’” ë¬¶ê¸° í•´ì œ</button>
    <button class="btn btn-outline" onclick="resetOrder()">ğŸ”„ ìˆœì„œ ì´ˆê¸°í™”</button>
    
    <div class="divider"></div>
    
    <div class="input-group" style="flex-direction:row; align-items:center;">
      <label style="margin:0;">ğŸ” ê²€ìƒ‰:</label>
      <input type="text" id="searchInput" placeholder="ìƒí’ˆëª…/ì½”ë“œ..." oninput="renderTable()" style="padding:6px; width:120px; border:1px solid #cbd5e1; border-radius:4px; outline:none;">
    </div>
  </div>

  <div class="stats-bar">
    <span class="stat-item">ì´ ê·¸ë£¹: <b id="totalCount">0</b></span>
    <span class="stat-item" style="color:var(--purple)">âš¡ ì½”ë“œë§¤ì¹­: <b id="codeMatchCount">0</b></span>
    <span class="stat-item" style="color:var(--success)">ğŸŒ¿ ì´ë¦„ë§¤ì¹­: <b id="nameMatchCount">0</b></span>
    <span class="stat-item" style="color:var(--danger)">âš ï¸ ë¯¸ì…ë ¥: <b id="errCount">0</b></span>
  </div>

  <div class="table-area">
    <table id="mainTable">
      <thead>
        <tr>
          <th class="col-chk"><input type="checkbox" id="chkAll" onchange="toggleAll(this)"></th>
          <th class="col-drag"></th>
          <th class="col-seq">NO.</th>
          <th class="col-status">ìƒíƒœ</th>
          <th class="col-name">ìƒí’ˆëª… (ì œí’ˆì„ íƒ)</th>
          <th class="col-old">ê¸°ì¡´ì½”ë“œ</th>
          <th class="col-code">ê´€ë¦¬ì½”ë“œ (ìˆ˜ì •/ì…ë ¥)</th>
          <th class="col-info">ì˜µì…˜</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="8" style="text-align:center; padding:100px; color:#cbd5e1;">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="ruleModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">ê·œì¹™ ê´€ë¦¬ & í´ë¼ìš°ë“œ</div>
      <div class="modal-close" onclick="closeRuleManager()">&times;</div>
    </div>
    <div class="modal-body">
      <div class="github-section">
        <div class="gh-title" style="font-size:12px; font-weight:700; margin-bottom:6px;">â˜ï¸ GitHub ë™ê¸°í™”</div>
        <div class="gh-inputs">
          <input type="password" id="ghToken" class="gh-input" placeholder="Token (ghp_...)">
          <input type="text" id="ghRepo" class="gh-input" placeholder="User/Repo" value="EasyHara/code_fix_data">
          <input type="text" id="ghPath" class="gh-input" placeholder="íŒŒì¼ëª…" value="code_rules.json" style="width:100px;">
        </div>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-outline" onclick="saveGithubConfig()" style="font-size:11px;">ì„¤ì • ì €ì¥</button>
          <button class="btn btn-dark" onclick="uploadToGithub()" style="font-size:11px;">â˜ï¸ ì—…ë¡œë“œ (ë°±ì—…)</button>
          <button class="btn btn-success" onclick="loadFromGithub()" style="font-size:11px;">â˜ï¸ ë‹¤ìš´ë¡œë“œ (ë³µì›)</button>
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" id="tabCode" onclick="switchTab('code')">âš¡ ì½”ë“œ ë§¤ì¹­ (<span id="cntCode">0</span>)</div>
        <div class="tab" id="tabName" onclick="switchTab('name')">ğŸŒ¿ ì´ë¦„ ë§¤ì¹­ (<span id="cntName">0</span>)</div>
      </div>
      <div class="search-bar" style="padding:10px 24px;">
        <input type="text" id="ruleSearch" placeholder="ê·œì¹™ ê²€ìƒ‰..." style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:4px; outline:none;" oninput="renderRuleList()">
      </div>
      <div class="rule-list" id="ruleListArea"></div>
    </div>
  </div>
</div>

<div id="optModal" class="modal-overlay">
  <div class="modal-content" style="width:600px; height:600px;">
    <div class="modal-header">
      <div class="modal-title" id="optModalTitle">ìƒì„¸ ì˜µì…˜</div>
      <div class="modal-close" onclick="closeOptModal()">&times;</div>
    </div>
    <div class="modal-body" style="padding:0;">
      <div class="rule-list" id="optListArea" style="padding:0;"></div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
  // ì €ì¥ì†Œ í‚¤
  const DB_KEY_CODE = "easyHara_db_by_code_v1"; 
  const DB_KEY_NAME = "easyHara_db_by_name_v1"; 

  // ì „ì—­ ë³€ìˆ˜
  let globalData = []; 
  let groupData = [];  
  let targetColKey = "", codeColKey = "";
  let colorColKey = "", sizeColKey = "", stockColKey = "";
  let currentTab = 'code'; 
  let lastCheckedIndex = null;
  let dragSrcIndex = null;
  let isSeqMode = false; 

  document.addEventListener('DOMContentLoaded', () => {
    const ghConfig = JSON.parse(localStorage.getItem('gh_config_fixer') || '{}');
    if(ghConfig.token) document.getElementById('ghToken').value = ghConfig.token;
    if(ghConfig.repo) document.getElementById('ghRepo').value = ghConfig.repo;
    if(ghConfig.path) document.getElementById('ghPath').value = ghConfig.path;
  });

  function handleFile(input) {
    const file = input.files[0];
    if (!file) return;
    document.getElementById('fileName').textContent = "ğŸ“„ " + file.name;

    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type: 'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      globalData = XLSX.utils.sheet_to_json(ws, { defval: "" });

      if (globalData.length === 0) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

      // ì»¬ëŸ¼ ìë™ ì¸ì‹
      const keys = Object.keys(globalData[0]);
      targetColKey = keys.find(k => /ì œí’ˆì„ íƒ|ì¶”ê°€ìƒí’ˆê°’|ì œí’ˆ|ì˜µì…˜/.test(k.replace(/\s/g,'')));
      codeColKey = keys.find(k => /ê´€ë¦¬ì½”ë“œ|ìƒí’ˆì½”ë“œ|ì½”ë“œ/.test(k.replace(/\s/g,'')));
      colorColKey = keys.find(k => /ìƒ‰ìƒ|color|opt1/i.test(k.replace(/\s/g,'')));
      sizeColKey = keys.find(k => /ì‚¬ì´ì¦ˆ|size|opt2/i.test(k.replace(/\s/g,'')));
      stockColKey = keys.find(k => /ì¬ê³ |ìˆ˜ëŸ‰|qty|stock/i.test(k.replace(/\s/g,'')));

      if (!targetColKey) { alert("ì œí’ˆì„ íƒ(ìƒí’ˆëª…) ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      if (!codeColKey) { codeColKey = "ê´€ë¦¬ì½”ë“œ"; }

      processGroups();
    };
    reader.readAsArrayBuffer(file);
  }

  function processGroups() {
    const dbCode = JSON.parse(localStorage.getItem(DB_KEY_CODE) || "{}");
    const dbName = JSON.parse(localStorage.getItem(DB_KEY_NAME) || "{}");
    
    groupData = [];
    let codeMatch = 0, nameMatch = 0, errCount = 0;
    const cleanNameRegex = /^[\s\[\(No\.\-]*\d+[\s\]\)\.\-]+/i; 

    const map = new Map();

    // 1ì°¨ ê·¸ë£¹í™”: ìƒí’ˆëª… + ê¸°ì¡´ì½”ë“œ
    globalData.forEach((row, idx) => {
      const rawName = String(row[targetColKey] || "");
      const cleanName = rawName.replace(cleanNameRegex, "").trim();
      const codeVal = String(row[codeColKey] || "").trim(); 

      if (!cleanName) return;

      const uniqueGroupKey = cleanName + "|||" + codeVal;

      if (!map.has(uniqueGroupKey)) {
        map.set(uniqueGroupKey, {
          cleanName: cleanName,
          rawName: rawName, 
          originalCode: codeVal, 
          rows: []
        });
      }
      map.get(uniqueGroupKey).rows.push(idx);
    });

    // 2ì°¨ ë¶„ì„
    map.forEach((val, uniqueGroupKey) => {
      let finalCode = val.originalCode;
      let status = "ok";
      let matchType = "none";
      let excludeSave = false; 

      const isProductOne = /^[\s\[\(]*(?:no\.?)?0*1[\s\]\)\.\-]/i.test(val.rawName);
      if (isProductOne) { excludeSave = true; }

      if (val.originalCode && dbCode[val.originalCode]) {
        finalCode = dbCode[val.originalCode];
        status = "auto"; matchType = "code"; codeMatch++;
      } else if (!val.originalCode && dbName[val.cleanName]) { 
        if (!isProductOne) {
            finalCode = dbName[val.cleanName];
            status = "auto"; matchType = "name"; nameMatch++;
        }
      }
      
      if (!finalCode) { status = "empty"; errCount++; } 
      else if (finalCode.length < 3) { status = "short"; errCount++; }

      groupData.push({
        cleanName: val.cleanName, 
        rawName: val.rawName,     
        displayName: val.rawName, 
        originalCode: val.originalCode,
        finalCode: finalCode, 
        rows: val.rows, 
        status: status, matchType: matchType, excludeSave: excludeSave,
        linkToPrev: false, 
        seq: 0,
        isChecked: false
      });
    });

    toggleSeqMode(false); 
    
    document.getElementById('codeMatchCount').innerText = codeMatch;
    document.getElementById('nameMatchCount').innerText = nameMatch;
    document.getElementById('errCount').innerText = errCount;
    document.getElementById('btnSave1').disabled = false;
    document.getElementById('btnSave2').disabled = false;
  }

  // [ì‹ ê·œ] ê³µí†µ: í–‰ íŒŒì‹± í•¨ìˆ˜ (í•©ì³ì§„ ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ ë¶„ë¦¬)
  function parseRowInfo(rowIdx) {
      const row = globalData[rowIdx];
      let color = colorColKey ? String(row[colorColKey] || "").trim() : "";
      let size = sizeColKey ? String(row[sizeColKey] || "").trim() : "";
      const stock = stockColKey ? String(row[stockColKey] || "").trim() : "";
      const name = String(row[targetColKey] || "").trim();

      // [í•µì‹¬] ì‚¬ì´ì¦ˆì— 'ìƒ‰ìƒ / ì‚¬ì´ì¦ˆ'ê°€ ê°™ì´ ìˆëŠ” ê²½ìš° ë¶„ë¦¬
      if (!color && size.includes('/')) {
          const parts = size.split('/').map(s => s.trim());
          if (parts.length >= 2) {
              // "ë¸”ë™ / 95" -> ìƒ‰ìƒ:ë¸”ë™, ì‚¬ì´ì¦ˆ:95
              color = parts[0];
              size = parts.slice(1).join(' / ');
          }
      }
      return { color, size, stock, name };
  }

  // [ì‹ ê·œ] ìƒ‰ìƒë³„ ë¶„ë¦¬ (Split)
  function splitByColor(idx) {
      const targetGroup = groupData[idx];
      const rows = targetGroup.rows;
      
      // ìƒ‰ìƒë³„ë¡œ í–‰ ë¶„ë¥˜ (parseRowInfo ì‚¬ìš©)
      const colorMap = {};
      rows.forEach(rowIdx => {
          const info = parseRowInfo(rowIdx);
          const color = info.color || "ê¸°íƒ€";
          if(!colorMap[color]) colorMap[color] = [];
          colorMap[color].push(rowIdx);
      });

      const colors = Object.keys(colorMap);
      if (colors.length <= 1) return alert("ë¶„ë¦¬í•  ìƒ‰ìƒì´ ì—†ê±°ë‚˜ 1ê°œë¿ì…ë‹ˆë‹¤.");

      const newGroups = colors.map(color => {
          return {
              ...targetGroup,
              displayName: `${targetGroup.displayName} [${color}]`, 
              cleanName: `${targetGroup.cleanName} [${color}]`,
              rows: colorMap[color],
              linkToPrev: false, isChecked: false
          };
      });

      groupData.splice(idx, 1, ...newGroups);
      recalcNumbers();
  }

  function toggleSeqMode(forceVal) {
    const chk = document.getElementById('useSeq');
    if (forceVal !== undefined) chk.checked = forceVal;
    
    isSeqMode = chk.checked;
    const formatInput = document.getElementById('formatStr');
    
    if (isSeqMode) {
        formatInput.style.display = 'block';
        groupData.forEach(item => { 
            if (!item.displayName.includes('[')) item.displayName = item.cleanName; 
        });
    } else {
        formatInput.style.display = 'none';
        groupData.forEach(item => { 
            if (!item.displayName.includes('[')) item.displayName = item.rawName;
        });
    }
    recalcNumbers();
  }

  function recalcNumbers() {
    let currentSeq = 0;
    groupData.forEach((item, i) => {
      if (i > 0 && item.linkToPrev) {
         item.seq = groupData[i-1].seq;
      } else {
         currentSeq++;
         item.seq = currentSeq;
      }
    });
    renderTable();
  }

  function renderTable() {
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = "";
    const formatStr = document.getElementById('formatStr').value || "00) ";
    const query = document.getElementById('searchInput').value.toLowerCase();

    const visibleItems = groupData.map((item, idx) => ({...item, orgIdx: idx}))
      .filter(item => !query || item.displayName.toLowerCase().includes(query) || item.finalCode.toLowerCase().includes(query));

    if(visibleItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:50px; color:#94a3b8;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    document.getElementById('totalCount').innerText = groupData.length;

    const fragment = document.createDocumentFragment();

    visibleItems.forEach((item) => {
      const i = item.orgIdx;
      const tr = document.createElement('tr');
      tr.setAttribute('draggable', true);
      tr.dataset.index = i;
      if(item.linkToPrev) tr.classList.add('linked');

      let badge = "", inputClass = "code-input";
      if (item.matchType === 'code') { badge = `<span class="badge badge-code">âš¡ ì½”ë“œ</span>`; inputClass += " auto-code"; }
      else if (item.matchType === 'name') { badge = `<span class="badge badge-name">ğŸŒ¿ ì´ë¦„</span>`; inputClass += " auto-name"; }
      else if (item.status === 'empty') { badge = `<span class="badge badge-err">í•„ìˆ˜</span>`; inputClass += " empty"; }
      else if (item.status === 'short') { badge = `<span class="badge badge-warn">í™•ì¸</span>`; inputClass += " short"; }
      else { badge = `<span class="badge badge-ok">ê¸°ì¡´</span>`; }

      const btnClass = item.excludeSave ? "btn-no-match active" : "btn-no-match";
      const btnText = item.excludeSave ? "ğŸ”• ë§¤ì¹­X" : "ğŸ”” ë§¤ì¹­O";
      
      let seqText = isSeqMode ? formatStr.replace('00', String(item.seq).padStart(2, '0')) : "-";
      let linkIcon = (i > 0 && item.linkToPrev && isSeqMode) ? `<span class="link-icon active">â†³</span>` : ``;

      // ìƒ‰ìƒ ë¶„ë¦¬ ë²„íŠ¼
      let splitBtn = "";
      if (item.rows.length > 1 && !item.displayName.includes('[')) {
         splitBtn = `<button class="btn-split" onclick="splitByColor(${i})">ğŸ¨ ë¶„ë¦¬</button>`;
      }

      tr.innerHTML = `
        <td class="col-chk"><input type="checkbox" class="row-chk" data-idx="${i}" ${item.isChecked ? 'checked' : ''}></td>
        <td class="col-drag">â‹®â‹®</td>
        <td class="col-seq">${linkIcon}${seqText}</td>
        <td class="col-status">${badge}</td>
        <td class="col-name">
          <input type="text" class="common-input name-input" value="${item.displayName}" 
            oninput="updateName(${i}, this.value)" onkeydown="handleKeyDown(event, ${i}, 'name')">
        </td>
        <td class="col-old" title="${item.originalCode}">${item.originalCode || '-'}</td>
        <td class="col-code">
          <div class="code-input-group">
            <button class="${btnClass}" onclick="toggleExclude(${i})" title="ê·œì¹™ ì €ì¥ ì—¬ë¶€">${btnText}</button>
            <input type="text" class="common-input ${inputClass}" value="${item.finalCode}" 
              oninput="updateCode(${i}, this.value)" onkeydown="handleKeyDown(event, ${i}, 'code')">
          </div>
        </td>
        <td class="col-info" style="display:flex; gap:4px; justify-content:center;">
          <button class="btn-view-opt" onclick="openOptModal(${i})">ğŸ” ${item.rows.length}</button>
          ${splitBtn}
        </td>
      `;
      
      addDragEvents(tr);
      tr.querySelector('.row-chk').addEventListener('click', (e) => handleCheck(e, i));

      fragment.appendChild(tr);
    });
    tbody.appendChild(fragment);
  }

  function updateName(idx, val) { groupData[idx].displayName = val; }

  // [í•µì‹¬] ì…ë ¥ ì‹œì—ëŠ” ì˜¤ì§ ë©”ëª¨ë¦¬ìƒì˜ ë°ì´í„°ë§Œ ë³€ê²½ (DB ì €ì¥ X)
  function updateCode(idx, val) {
    groupData[idx].finalCode = val; 
  }

  // [ì‹ ê·œ] ì¼ê´„ ì €ì¥ í•¨ìˆ˜ (íŒŒì¼ ì €ì¥ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ì‹¤í–‰)
  function saveAllRules() {
    const dbCode = JSON.parse(localStorage.getItem(DB_KEY_CODE) || "{}");
    const dbName = JSON.parse(localStorage.getItem(DB_KEY_NAME) || "{}");

    groupData.forEach(item => {
        if (item.excludeSave) return; 

        const cleanVal = item.finalCode.trim(); // ì €ì¥í•  ë• ê³µë°± ì œê±°

        if (cleanVal) {
            if (item.originalCode && item.originalCode !== cleanVal) {
                dbCode[item.originalCode] = cleanVal;
            }
            dbName[item.cleanName] = cleanVal;
        } else {
            if (item.originalCode) delete dbCode[item.originalCode];
            delete dbName[item.cleanName];
        }
    });

    localStorage.setItem(DB_KEY_CODE, JSON.stringify(dbCode));
    localStorage.setItem(DB_KEY_NAME, JSON.stringify(dbName));
  }

  function toggleExclude(idx) {
    groupData[idx].excludeSave = !groupData[idx].excludeSave;
    const tr = document.querySelector(`input[oninput*="updateCode(${idx}"]`).closest('tr');
    const btn = tr.querySelector('.btn-no-match');
    btn.className = groupData[idx].excludeSave ? "btn-no-match active" : "btn-no-match";
    btn.textContent = groupData[idx].excludeSave ? "ğŸ”• ë§¤ì¹­X" : "ğŸ”” ë§¤ì¹­O";
  }

  function handleKeyDown(e, idx, type) {
    const rows = groupData.length;
    let nextIdx = idx;
    if (e.key === 'Enter' || e.key === 'ArrowDown') {
        e.preventDefault(); nextIdx = e.shiftKey ? idx - 1 : idx + 1;
    } else if (e.key === 'ArrowUp') {
        e.preventDefault(); nextIdx = idx - 1;
    }
    if (nextIdx >= 0 && nextIdx < rows) {
        const trs = document.querySelectorAll('#tbody tr');
        const targetInput = type === 'name' 
            ? trs[nextIdx].querySelector('.name-input') 
            : trs[nextIdx].querySelector('.code-input-group input.common-input');
        if(targetInput) { targetInput.focus(); targetInput.select(); }
    }
  }

  function handleCheck(e, idx) {
    const checked = e.target.checked;
    groupData[idx].isChecked = checked;
    if (e.shiftKey && lastCheckedIndex !== null) {
      const start = Math.min(lastCheckedIndex, idx);
      const end = Math.max(lastCheckedIndex, idx);
      for(let k=start; k<=end; k++) groupData[k].isChecked = checked;
      renderTable();
    }
    lastCheckedIndex = idx;
  }

  function toggleAll(source) {
    groupData.forEach(item => item.isChecked = source.checked);
    renderTable();
  }

  function groupSelected() {
    if (!isSeqMode) return alert("ìˆœë²ˆ ì •ë ¬ ì ìš© ì²´í¬ë°•ìŠ¤ë¥¼ ì¼œì£¼ì„¸ìš”.");
    let changed = false;
    groupData.forEach((item, idx) => {
        if(item.isChecked && idx > 0) { item.linkToPrev = true; changed = true; item.isChecked = false; }
    });
    if(changed) { recalcNumbers(); document.getElementById('chkAll').checked = false; }
    else alert("ì„ íƒëœ í•­ëª©ì´ ì—†ê±°ë‚˜ ì²«ë²ˆì§¸ í–‰ì…ë‹ˆë‹¤.");
  }
  function ungroupSelected() {
    if (!isSeqMode) return alert("ìˆœë²ˆ ì •ë ¬ ì ìš© ì²´í¬ë°•ìŠ¤ë¥¼ ì¼œì£¼ì„¸ìš”.");
    let changed = false;
    groupData.forEach(item => {
        if(item.isChecked) { item.linkToPrev = false; changed = true; item.isChecked = false; }
    });
    if(changed) { recalcNumbers(); document.getElementById('chkAll').checked = false; }
  }
  function resetOrder() {
    if(!globalData.length) return;
    processGroups(); 
  }

  function addDragEvents(tr) {
    tr.addEventListener('dragstart', e => {
        dragSrcIndex = +tr.dataset.index; e.dataTransfer.effectAllowed = 'move'; tr.classList.add('dragging');
    });
    tr.addEventListener('dragover', e => { e.preventDefault(); tr.classList.add('drag-over'); });
    tr.addEventListener('dragleave', () => tr.classList.remove('drag-over'));
    tr.addEventListener('drop', e => {
        e.stopPropagation();
        const dropIndex = +tr.dataset.index;
        if(dragSrcIndex !== dropIndex) {
            const moved = groupData.splice(dragSrcIndex, 1)[0];
            groupData.splice(dropIndex, 0, moved);
            moved.linkToPrev = false; 
            if(groupData[dropIndex+1]) groupData[dropIndex+1].linkToPrev = false;
            recalcNumbers();
        }
        return false;
    });
    tr.addEventListener('dragend', () => {
        tr.classList.remove('dragging');
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    });
  }

  // ì €ì¥ ë¡œì§ (ì´ë•Œ DB ì €ì¥ë„ ìˆ˜í–‰)
  function createWorkbook() {
    const finalData = JSON.parse(JSON.stringify(globalData));
    const formatStr = document.getElementById('formatStr').value || "00) ";
    
    groupData.forEach(item => {
      let finalName = item.displayName;
      if (isSeqMode) {
          const seqStr = formatStr.replace('00', String(item.seq).padStart(2, '0'));
          finalName = `${seqStr}${item.displayName}`; 
      }
      
      item.rows.forEach(rowIdx => {
        finalData[rowIdx][codeColKey] = item.finalCode.trim();
        finalData[rowIdx][targetColKey] = finalName; 
      });
    });
    const ws = XLSX.utils.json_to_sheet(finalData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    return wb;
  }

  async function downloadOverwrite() {
    if (!globalData.length) return;
    
    saveAllRules(); // ì €ì¥ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ê·œì¹™ ì¼ê´„ ì €ì¥

    const wb = createWorkbook();
    const wbOut = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbOut], {type: "application/octet-stream"});
    const originalFile = document.getElementById('fileInput').files[0];
    
    if (window.showSaveFilePicker) {
        try {
            const handle = await window.showSaveFilePicker({
                suggestedName: originalFile.name,
                types: [{ description: 'Excel', accept: {'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']} }],
            });
            const writable = await handle.createWritable();
            await writable.write(blob); await writable.close();
            showToast("âœ… ì €ì¥ ì™„ë£Œ & ê·œì¹™ ì—…ë°ì´íŠ¸!");
            if(document.getElementById('ruleModal').style.display === 'flex') renderRuleList();
        } catch (err) { if(err.name !== 'AbortError') alert("ì €ì¥ ì‹¤íŒ¨: " + err); }
    } else {
        saveAs(blob, originalFile.name);
    }
  }

  function downloadNew() {
    if (!globalData.length) return;

    saveAllRules(); // ì €ì¥ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ê·œì¹™ ì¼ê´„ ì €ì¥

    const wb = createWorkbook();
    const wbOut = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbOut], {type: "application/octet-stream"});
    const originalFile = document.getElementById('fileInput').files[0];
    saveAs(blob, originalFile.name); 
    showToast("âœ… ì €ì¥ ì™„ë£Œ & ê·œì¹™ ì—…ë°ì´íŠ¸!");
    if(document.getElementById('ruleModal').style.display === 'flex') renderRuleList();
  }

  // ì˜µì…˜ ë³´ê¸° ëª¨ë‹¬ (ìŠ¤ë§ˆíŠ¸ íŒŒì‹± ì ìš©)
  function openOptModal(idx) {
    const item = groupData[idx];
    document.getElementById('optModalTitle').textContent = `[${item.displayName}] ì˜µì…˜ ëª©ë¡ (${item.rows.length}ê°œ)`;
    const list = document.getElementById('optListArea');
    let html = `<table class="opt-table"><thead><tr><th>ìƒ‰ìƒ</th><th>ì‚¬ì´ì¦ˆ</th><th>ì¬ê³ </th><th>ì›ë³¸ëª…</th></tr></thead><tbody>`;
    item.rows.forEach(rowIdx => {
        const info = parseRowInfo(rowIdx); // ìŠ¤ë§ˆíŠ¸ íŒŒì‹± ì‚¬ìš©
        html += `<tr>
            <td style="font-weight:bold; color:#475569;">${info.color||'-'}</td>
            <td>${info.size||'-'}</td>
            <td>${info.stock||'-'}</td>
            <td style="color:#94a3b8;">${info.name||''}</td>
        </tr>`;
    });
    html += `</tbody></table>`;
    list.innerHTML = html;
    document.getElementById('optModal').style.display = 'flex';
  }
  function closeOptModal() { document.getElementById('optModal').style.display = 'none'; }

  function resetAll() { if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) location.reload(); }
  function showToast(msg) {
    const t = document.getElementById("toast"); t.innerText = msg; t.className = "show";
    setTimeout(() => t.className = t.className.replace("show", ""), 3000);
  }

  // ê·œì¹™ ê´€ë¦¬ì ê´€ë ¨
  function openRuleManager() { document.getElementById('ruleModal').style.display = 'flex'; renderRuleList(); }
  function closeRuleManager() { document.getElementById('ruleModal').style.display = 'none'; if(globalData.length) processGroups(); }
  function switchTab(tab) { currentTab = tab; document.getElementById('tabCode').className = tab==='code'?'tab active':'tab'; document.getElementById('tabName').className = tab==='name'?'tab active':'tab'; renderRuleList(); }
  
  function renderRuleList() {
    const db = JSON.parse(localStorage.getItem(currentTab === 'code' ? DB_KEY_CODE : DB_KEY_NAME) || "{}");
    const list = document.getElementById('ruleListArea');
    const q = document.getElementById('ruleSearch').value.toLowerCase();
    list.innerHTML = "";
    
    document.getElementById('cntCode').innerText = Object.keys(JSON.parse(localStorage.getItem(DB_KEY_CODE)||'{}')).length;
    document.getElementById('cntName').innerText = Object.keys(JSON.parse(localStorage.getItem(DB_KEY_NAME)||'{}')).length;

    Object.keys(db).sort().forEach(key => {
        if(q && !key.toLowerCase().includes(q) && !db[key].toLowerCase().includes(q)) return;
        const div = document.createElement('div'); div.className = 'rule-item';
        div.innerHTML = `<div class="rule-key">${key}</div><div class="rule-arrow">âœ</div>
        <input type="text" class="rule-val-input" value="${db[key]}" onchange="saveRule('${key}', this.value)">
        <div class="rule-del" onclick="deleteRule('${key}')">ì‚­ì œ</div>`;
        list.appendChild(div);
    });
  }
  
  function saveRule(key, val) {
    const k = currentTab==='code'?DB_KEY_CODE:DB_KEY_NAME; const db=JSON.parse(localStorage.getItem(k));
    if(val.trim()) { db[key]=val.trim(); localStorage.setItem(k, JSON.stringify(db)); } else deleteRule(key);
  }
  function deleteRule(key) {
    if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const k = currentTab==='code'?DB_KEY_CODE:DB_KEY_NAME; const db=JSON.parse(localStorage.getItem(k));
    delete db[key]; localStorage.setItem(k, JSON.stringify(db)); renderRuleList();
  }

  // GitHub ì—°ë™
  function saveGithubConfig() {
    const t = document.getElementById('ghToken').value; const r = document.getElementById('ghRepo').value; const p = document.getElementById('ghPath').value;
    if(!t || !r) return alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    localStorage.setItem('gh_config_fixer', JSON.stringify({token:t, repo:r, path:p})); showToast("ì„¤ì • ì €ì¥ë¨");
  }
  async function uploadToGithub() {
    const c = JSON.parse(localStorage.getItem('gh_config_fixer')||'{}'); if(!c.token) return alert("ì„¤ì • í•„ìš”");
    const data = { codeDB: JSON.parse(localStorage.getItem(DB_KEY_CODE)||'{}'), nameDB: JSON.parse(localStorage.getItem(DB_KEY_NAME)||'{}') };
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    try {
        const res = await fetch(`https://api.github.com/repos/${c.repo}/contents/${c.path}`, {headers:{'Authorization':`token ${c.token}`}});
        let sha = res.ok ? (await res.json()).sha : null;
        const put = await fetch(`https://api.github.com/repos/${c.repo}/contents/${c.path}`, {
            method:'PUT', headers:{'Authorization':`token ${c.token}`},
            body:JSON.stringify({message:'Backup', content:content, sha:sha})
        });
        if(put.ok) showToast("âœ… ì—…ë¡œë“œ ì™„ë£Œ"); else alert("ì‹¤íŒ¨");
    } catch(e) { alert("ì˜¤ë¥˜:"+e); }
  }
  async function loadFromGithub() {
    const c = JSON.parse(localStorage.getItem('gh_config_fixer')||'{}'); if(!c.token) return alert("ì„¤ì • í•„ìš”");
    try {
        const res = await fetch(`https://api.github.com/repos/${c.repo}/contents/${c.path}`, {headers:{'Authorization':`token ${c.token}`, 'Accept':'application/vnd.github.v3+json'}});
        if(!res.ok) throw new Error("íŒŒì¼ ì—†ìŒ");
        const d = JSON.parse(decodeURIComponent(escape(atob((await res.json()).content))));
        if(d.codeDB) localStorage.setItem(DB_KEY_CODE, JSON.stringify(d.codeDB));
        if(d.nameDB) localStorage.setItem(DB_KEY_NAME, JSON.stringify(d.nameDB));
        showToast("âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"); renderRuleList();
    } catch(e) { alert("ì‹¤íŒ¨:"+e); }
  }
</script>
</body>
</html>
