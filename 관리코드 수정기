<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì½”ë“œ ìŠ¤ë§ˆíŠ¸ ìˆ˜ì •ê¸° (í´ë¼ìš°ë“œ ë™ê¸°í™”)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    /* --- ë©”ì¸ ìŠ¤íƒ€ì¼ --- */
    :root {
      --primary: #3b82f6; --bg: #f1f5f9; --card: #ffffff; --border: #e2e8f0;
      --text: #1e293b; --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
      --purple: #8b5cf6; --github: #24292f;
    }
    body {
      font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); color: var(--text);
      margin: 0; padding: 20px; display: flex; justify-content: center;
    }
    .container {
      width: 1400px; max-width: 98vw; background: var(--card); border-radius: 16px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 92vh;
    }
    
    .header {
      padding: 20px 30px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center; background: #fff;
    }
    .header h1 { margin: 0; font-size: 22px; font-weight: 800; color: #0f172a; }
    .header p { margin: 4px 0 0; font-size: 13px; color: #64748b; }

    .controls {
      padding: 16px 30px; background: #f8fafc; border-bottom: 1px solid var(--border);
      display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;
    }
    .input-group { display: flex; flex-direction: column; gap: 6px; }
    .input-group label { font-size: 12px; font-weight: 700; color: #475569; }
    
    .file-label {
      background: #fff; border: 1px solid #cbd5e1; padding: 10px 16px; border-radius: 8px;
      font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; transition: 0.2s;
    }
    .file-label:hover { border-color: var(--primary); color: var(--primary); background: #eff6ff; }
    input[type="file"] { display: none; }

    .btn {
      padding: 10px 18px; border-radius: 8px; font-size: 13px; font-weight: 700; border: none; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 4px;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: var(--success); color: #fff; margin-left: auto; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2); }
    .btn-success:hover:not(:disabled) { background: #059669; transform: translateY(-1px); }
    .btn-danger { background: #fee2e2; color: var(--danger); }
    .btn-danger:hover { background: #fecaca; }
    .btn-github { background: var(--github); color: #fff; }
    .btn-github:hover { background: #000; }
    .btn:disabled { background: #e2e8f0; cursor: not-allowed; color: #94a3b8; box-shadow: none; }

    .stats-bar {
      padding: 12px 30px; background: #fff; border-bottom: 1px solid var(--border);
      font-size: 13px; display: flex; gap: 24px; color: #64748b; font-weight: 500;
    }
    .stat-item b { font-weight: 800; margin-left: 4px; font-size: 14px; }
    
    .table-area { flex: 1; overflow-y: auto; position: relative; background: #fff; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
    thead th {
      position: sticky; top: 0; background: #f8fafc; z-index: 10; padding: 14px 20px;
      text-align: left; color: #64748b; font-weight: 600; border-bottom: 1px solid var(--border);
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    tbody td { padding: 10px 20px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; }
    tbody tr:hover { background: #f8fafc; }

    .code-input {
      width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;
      font-family: 'Monaco', monospace; font-size: 13px; transition: 0.2s; box-sizing: border-box;
    }
    .code-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); background: #fff; }
    .code-input.empty { border-color: var(--danger); background: #fef2f2; }
    .code-input.short { border-color: var(--warning); background: #fffbeb; }
    .code-input.auto-code { border-color: var(--purple); background: #f5f3ff; color: #5b21b6; font-weight: 600; }
    .code-input.auto-name { border-color: var(--success); background: #f0fdf4; color: #065f46; font-weight: 600; }

    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; display: inline-block; min-width: 50px; text-align:center; }
    .badge-err { background: #fee2e2; color: var(--danger); }
    .badge-warn { background: #fef3c7; color: #d97706; }
    .badge-ok { background: #f1f5f9; color: #64748b; }
    .badge-code { background: #ede9fe; color: var(--purple); }
    .badge-name { background: #dcfce7; color: var(--success); }

    .col-status { width: 100px; text-align: center; }
    .col-name { width: 35%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .col-old { width: 15%; color: #94a3b8; font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .col-code { width: 25%; }
    .col-info { width: auto; color: #94a3b8; font-size: 12px; text-align: right; }

    /* --- ëª¨ë‹¬ --- */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff; width: 900px; max-width: 95vw; height: 85vh;
      border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .modal-header {
      padding: 20px 24px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-title { font-size: 18px; font-weight: 800; color: #0f172a; }
    .modal-close { cursor: pointer; font-size: 24px; color: #94a3b8; line-height: 1; }
    .modal-close:hover { color: #ef4444; }

    .modal-body { flex: 1; display: flex; flex-direction: column; background: #f8fafc; overflow: hidden; }
    .tabs { display: flex; gap: 2px; padding: 0 24px; margin-top: 20px; border-bottom: 1px solid var(--border); }
    .tab {
      padding: 10px 20px; font-size: 14px; font-weight: 600; color: #64748b; cursor: pointer;
      border-top-left-radius: 8px; border-top-right-radius: 8px; background: #e2e8f0;
    }
    .tab.active { background: #fff; color: var(--primary); border: 1px solid var(--border); border-bottom: 1px solid #fff; margin-bottom: -1px; }

    .search-bar { padding: 16px 24px; background: #fff; display: flex; border-bottom: 1px solid #f1f5f9; }
    .search-input { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; }

    .rule-list { flex: 1; overflow-y: auto; padding: 0 24px 24px 24px; background: #fff; }
    .rule-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; gap: 12px; }
    .rule-key { flex: 1; font-size: 13px; color: #475569; font-weight: 500; }
    .rule-arrow { color: #cbd5e1; font-size: 14px; }
    .rule-val-input { flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 13px; font-family: monospace; }
    .rule-val-input:focus { border-color: var(--primary); outline: none; }
    .rule-del { padding: 6px 10px; background: #fee2e2; color: #ef4444; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; }
    .rule-del:hover { background: #fecaca; }
    .empty-state { text-align: center; padding: 40px; color: #94a3b8; font-size: 14px; }

    /* GitHub ì„¹ì…˜ */
    .github-section {
      margin: 20px 24px; padding: 16px; background: #f1f5f9; border-radius: 8px; border: 1px solid #e2e8f0;
    }
    .gh-title { font-size: 13px; font-weight: 700; color: #334155; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .gh-inputs { display: flex; gap: 8px; margin-bottom: 10px; }
    .gh-input { flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div>
      <h1>ğŸ› ï¸ ê´€ë¦¬ì½”ë“œ ìŠ¤ë§ˆíŠ¸ ìˆ˜ì •ê¸°</h1>
      <p>í•˜ì´ë¸Œë¦¬ë“œ ìë™ì™„ì„± + GitHub í´ë¼ìš°ë“œ ë™ê¸°í™” ì§€ì›</p>
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn btn-primary" onclick="openRuleManager()">âš™ï¸ ê·œì¹™ ê´€ë¦¬ / ë™ê¸°í™”</button>
      <button class="btn btn-danger" onclick="resetAll()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="controls">
    <div class="input-group">
      <label>íŒŒì¼ ì„ íƒ</label>
      <label class="file-label">
        <span id="fileName">ğŸ“‚ ì—‘ì…€ íŒŒì¼ ì—´ê¸° (xls, xlsx)</span>
        <input type="file" id="fileInput" accept=".xls,.xlsx" onchange="handleFile(this)">
      </label>
    </div>
    <div style="flex:1;"></div>
    <button class="btn btn-success" id="dnBtn" onclick="downloadExcel()" disabled>ğŸ’¾ ë®ì–´ì“°ê¸° ì €ì¥ (Chrome)</button>
  </div>

  <div class="stats-bar">
    <span class="stat-item">ì´ ê·¸ë£¹: <b id="totalCount">0</b></span>
    <span class="stat-item" style="color:var(--purple)">âš¡ ì½”ë“œë§¤ì¹­: <b id="codeMatchCount">0</b></span>
    <span class="stat-item" style="color:var(--success)">ğŸŒ¿ ì´ë¦„ë§¤ì¹­: <b id="nameMatchCount">0</b></span>
    <span class="stat-item" style="color:var(--danger)">âš ï¸ ë¯¸ì…ë ¥: <b id="errCount">0</b></span>
  </div>

  <div class="table-area">
    <table>
      <thead>
        <tr>
          <th class="col-status">ìƒíƒœ</th>
          <th class="col-name">ìƒí’ˆëª… (ì œí’ˆì„ íƒ)</th>
          <th class="col-old">ê¸°ì¡´ ì½”ë“œ</th>
          <th class="col-code">ê´€ë¦¬ì½”ë“œ (ìˆ˜ì • ê²°ê³¼)</th>
          <th class="col-info">ì˜µì…˜ ìˆ˜</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="5" style="text-align:center; padding:100px; color:#cbd5e1;">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="ruleModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">ê·œì¹™ ê´€ë¦¬ì & í´ë¼ìš°ë“œ</div>
      <div class="modal-close" onclick="closeRuleManager()">&times;</div>
    </div>
    <div class="modal-body">
      
      <div class="github-section">
        <div class="gh-title">â˜ï¸ GitHub í´ë¼ìš°ë“œ ë™ê¸°í™”</div>
        <div class="gh-inputs">
          <input type="password" id="ghToken" class="gh-input" placeholder="GitHub Token (ghp_...)">
          <input type="text" id="ghRepo" class="gh-input" placeholder="User/Repo (ì˜ˆ: my/data)" value="EasyHara/code_fix_data">
          <input type="text" id="ghPath" class="gh-input" placeholder="íŒŒì¼ëª…" value="code_rules.json" style="width:120px;">
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-github" style="background:#475569;" onclick="saveGithubConfig()">í† í° ì €ì¥</button>
          <button class="btn btn-github" onclick="uploadToGithub()">â˜ï¸ ì—…ë¡œë“œ (ë°±ì—…)</button>
          <button class="btn btn-success" onclick="loadFromGithub()">â˜ï¸ ë‹¤ìš´ë¡œë“œ (ë³µì›)</button>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" id="tabCode" onclick="switchTab('code')">âš¡ ì½”ë“œ ë§¤ì¹­ (<span id="cntCode">0</span>)</div>
        <div class="tab" id="tabName" onclick="switchTab('name')">ğŸŒ¿ ì´ë¦„ ë§¤ì¹­ (<span id="cntName">0</span>)</div>
      </div>
      <div class="search-bar">
        <input type="text" class="search-input" id="ruleSearch" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." oninput="renderRuleList()">
      </div>
      <div class="rule-list" id="ruleListArea"></div>
    </div>
  </div>
</div>

<script>
  // ì €ì¥ì†Œ í‚¤ ì„¤ì •
  const DB_KEY_CODE = "easyHara_db_by_code_v1"; 
  const DB_KEY_NAME = "easyHara_db_by_name_v1"; 

  let globalData = [];
  let groupData = []; 
  let targetColKey = "";
  let codeColKey = "";
  let currentTab = 'code'; 

  // ì´ˆê¸°í™” ë° ì„¤ì • ë¡œë“œ
  document.addEventListener('DOMContentLoaded', () => {
    const ghConfig = JSON.parse(localStorage.getItem('gh_config_fixer') || '{}');
    if(ghConfig.token) document.getElementById('ghToken').value = ghConfig.token;
    if(ghConfig.repo) document.getElementById('ghRepo').value = ghConfig.repo;
    if(ghConfig.path) document.getElementById('ghPath').value = ghConfig.path;
  });

  function handleFile(input) {
    const file = input.files[0];
    if (!file) return;
    document.getElementById('fileName').textContent = "ğŸ“„ " + file.name;

    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type: 'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      globalData = XLSX.utils.sheet_to_json(ws, { defval: "" });

      if (globalData.length === 0) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

      const keys = Object.keys(globalData[0]);
      targetColKey = keys.find(k => /ì œí’ˆì„ íƒ|ì¶”ê°€ìƒí’ˆê°’|ì œí’ˆ|ì˜µì…˜/.test(k.replace(/\s/g,'')));
      codeColKey = keys.find(k => /ê´€ë¦¬ì½”ë“œ|ìƒí’ˆì½”ë“œ|ì½”ë“œ/.test(k.replace(/\s/g,'')));

      if (!targetColKey) { alert("ì œí’ˆì„ íƒ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      if (!codeColKey) { codeColKey = "ê´€ë¦¬ì½”ë“œ"; }

      processGroups();
    };
    reader.readAsArrayBuffer(file);
  }

  function processGroups() {
    const dbCode = JSON.parse(localStorage.getItem(DB_KEY_CODE) || "{}");
    const dbName = JSON.parse(localStorage.getItem(DB_KEY_NAME) || "{}");
    
    groupData = [];
    let codeMatch = 0, nameMatch = 0, errCount = 0;
    const cleanNameRegex = /^[\s\[\(No\.\-]*\d+[\s\]\)\.\-]+/i; 

    const map = new Map();

    globalData.forEach((row, idx) => {
      const rawName = String(row[targetColKey] || "");
      const cleanName = rawName.replace(cleanNameRegex, "").trim();
      if (!cleanName) return;

      if (!map.has(cleanName)) {
        map.set(cleanName, {
          cleanName: cleanName, rawName: rawName, 
          originalCode: String(row[codeColKey] || "").trim(),
          rows: []
        });
      }
      map.get(cleanName).rows.push(idx);
    });

    map.forEach((val, key) => {
      let finalCode = val.originalCode;
      let status = "ok";
      let matchType = "none";

      if (val.originalCode && dbCode[val.originalCode]) {
        finalCode = dbCode[val.originalCode];
        status = "auto";
        matchType = "code";
        codeMatch++;
      } else if (!val.originalCode && dbName[key]) {
        finalCode = dbName[key];
        status = "auto";
        matchType = "name";
        nameMatch++;
      }
      
      if (!finalCode) { status = "empty"; errCount++; } 
      else if (finalCode.length < 3) { status = "short"; errCount++; }

      groupData.push({
        cleanName: key, displayName: val.rawName, originalCode: val.originalCode,
        finalCode: finalCode, rows: val.rows, status: status, matchType: matchType
      });
    });

    renderTable(codeMatch, nameMatch, errCount);
  }

  function renderTable(cMatch, nMatch, err) {
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = "";

    groupData.forEach((item, idx) => {
      const tr = document.createElement('tr');
      let badge = "", inputClass = "code-input";
      
      if (item.matchType === 'code') { badge = `<span class="badge badge-code">âš¡ ì½”ë“œìˆ˜ì •</span>`; inputClass += " auto-code"; }
      else if (item.matchType === 'name') { badge = `<span class="badge badge-name">ğŸŒ¿ ê³µë€ì±„ì›€</span>`; inputClass += " auto-name"; }
      else if (item.status === 'empty') { badge = `<span class="badge badge-err">í•„ìˆ˜ì…ë ¥</span>`; inputClass += " empty"; }
      else if (item.status === 'short') { badge = `<span class="badge badge-warn">í™•ì¸í•„ìš”</span>`; inputClass += " short"; }
      else { badge = `<span class="badge badge-ok">ê¸°ì¡´ìœ ì§€</span>`; }

      tr.innerHTML = `
        <td class="col-status">${badge}</td>
        <td class="col-name" title="${item.cleanName}">${item.displayName}</td>
        <td class="col-old" title="${item.originalCode}">${item.originalCode || '-'}</td>
        <td class="col-code">
          <input type="text" class="${inputClass}" value="${item.finalCode}" 
            onchange="updateCode(${idx}, this.value)">
        </td>
        <td class="col-info">${item.rows.length}ê±´</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('totalCount').innerText = groupData.length;
    document.getElementById('codeMatchCount').innerText = cMatch;
    document.getElementById('nameMatchCount').innerText = nMatch;
    document.getElementById('errCount').innerText = err;
    document.getElementById('dnBtn').disabled = false;
  }

  function updateCode(idx, newCode) {
    newCode = newCode.trim();
    const item = groupData[idx];
    item.finalCode = newCode;
    
    const dbCode = JSON.parse(localStorage.getItem(DB_KEY_CODE) || "{}");
    const dbName = JSON.parse(localStorage.getItem(DB_KEY_NAME) || "{}");
    
    if (newCode) {
      if (item.originalCode && item.originalCode !== newCode) {
        dbCode[item.originalCode] = newCode;
      }
      dbName[item.cleanName] = newCode;
    } else {
      if(item.originalCode) delete dbCode[item.originalCode];
      delete dbName[item.cleanName];
    }
    localStorage.setItem(DB_KEY_CODE, JSON.stringify(dbCode));
    localStorage.setItem(DB_KEY_NAME, JSON.stringify(dbName));
  }

  // ë®ì–´ì“°ê¸° ì €ì¥ (File System Access API)
  async function downloadExcel() {
    if (globalData.length === 0) return;

    const finalData = JSON.parse(JSON.stringify(globalData));
    groupData.forEach(group => {
      group.rows.forEach(rowIdx => {
        finalData[rowIdx][codeColKey] = group.finalCode;
      });
    });

    const ws = XLSX.utils.json_to_sheet(finalData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

    const originalFile = document.getElementById('fileInput').files[0];
    const fileName = originalFile ? originalFile.name : "result.xlsx";
    const wbOut = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbOut], {type: "application/octet-stream"});

    if (window.showSaveFilePicker) {
        try {
            const handle = await window.showSaveFilePicker({
                suggestedName: fileName,
                types: [{ description: 'Excel File', accept: {'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']} }],
            });
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            return;
        } catch (err) { if (err.name !== 'AbortError') console.error(err); return; }
    }
    saveAs(blob, fileName);
  }

  function resetAll() {
    if (!confirm("ì‘ì—…ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    location.reload();
  }

  // ëª¨ë‹¬ ë° ê·œì¹™ ê´€ë¦¬
  function openRuleManager() { document.getElementById('ruleModal').style.display = 'flex'; renderRuleList(); }
  function closeRuleManager() { document.getElementById('ruleModal').style.display = 'none'; if(globalData.length > 0) processGroups(); }
  function switchTab(tab) { currentTab = tab; document.getElementById('tabCode').className = tab === 'code' ? 'tab active' : 'tab'; document.getElementById('tabName').className = tab === 'name' ? 'tab active' : 'tab'; renderRuleList(); }
  
  function renderRuleList() {
    const dbKey = currentTab === 'code' ? DB_KEY_CODE : DB_KEY_NAME;
    const db = JSON.parse(localStorage.getItem(dbKey) || "{}");
    const listArea = document.getElementById('ruleListArea');
    const query = document.getElementById('ruleSearch').value.toLowerCase();
    
    document.getElementById('cntCode').innerText = Object.keys(JSON.parse(localStorage.getItem(DB_KEY_CODE) || "{}")).length;
    document.getElementById('cntName').innerText = Object.keys(JSON.parse(localStorage.getItem(DB_KEY_NAME) || "{}")).length;

    listArea.innerHTML = "";
    const keys = Object.keys(db).sort();
    let hasItem = false;

    keys.forEach(key => {
      const val = db[key];
      if (query && !key.toLowerCase().includes(query) && !val.toLowerCase().includes(query)) return;
      hasItem = true;
      const div = document.createElement('div');
      div.className = 'rule-item';
      div.innerHTML = `
        <div class="rule-key" title="${key}">${key}</div>
        <div class="rule-arrow">âœ</div>
        <input type="text" class="rule-val-input" value="${val}" onchange="saveRule('${key}', this.value)">
        <div class="rule-del" onclick="deleteRule('${key}')">ì‚­ì œ</div>
      `;
      listArea.appendChild(div);
    });
    if (!hasItem) listArea.innerHTML = `<div class="empty-state">ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }

  function saveRule(key, newVal) {
    const dbKey = currentTab === 'code' ? DB_KEY_CODE : DB_KEY_NAME;
    const db = JSON.parse(localStorage.getItem(dbKey) || "{}");
    if (newVal.trim()) { db[key] = newVal.trim(); localStorage.setItem(dbKey, JSON.stringify(db)); } else { deleteRule(key); }
  }

  function deleteRule(key) {
    if(!confirm(`ê·œì¹™ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    const dbKey = currentTab === 'code' ? DB_KEY_CODE : DB_KEY_NAME;
    const db = JSON.parse(localStorage.getItem(dbKey) || "{}");
    delete db[key];
    localStorage.setItem(dbKey, JSON.stringify(db));
    renderRuleList();
  }

  // ==========================================
  // GitHub ì—°ë™ ë¡œì§
  // ==========================================
  function saveGithubConfig() {
    const token = document.getElementById('ghToken').value.trim();
    const repo = document.getElementById('ghRepo').value.trim();
    const path = document.getElementById('ghPath').value.trim();
    if(!token || !repo) return alert('í† í°ê³¼ ì €ì¥ì†Œ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    localStorage.setItem('gh_config_fixer', JSON.stringify({ token, repo, path }));
    alert("GitHub ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  async function uploadToGithub() {
    const conf = JSON.parse(localStorage.getItem('gh_config_fixer') || '{}');
    if(!conf.token) return alert('í† í° ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    
    // ë‘ DBë¥¼ í•©ì³ì„œ ì €ì¥
    const combinedData = {
      codeDB: JSON.parse(localStorage.getItem(DB_KEY_CODE) || '{}'),
      nameDB: JSON.parse(localStorage.getItem(DB_KEY_NAME) || '{}')
    };
    
    const content = JSON.stringify(combinedData, null, 2);
    const contentBase64 = btoa(unescape(encodeURIComponent(content)));
    const url = `https://api.github.com/repos/${conf.repo}/contents/${conf.path}`;

    try {
      // ê¸°ì¡´ íŒŒì¼ SHA ê°€ì ¸ì˜¤ê¸° (ë®ì–´ì“°ê¸° ìœ„í•´ í•„ìˆ˜)
      let sha = null;
      const getRes = await fetch(url, { headers: { 'Authorization': `token ${conf.token}` } });
      if (getRes.ok) { const json = await getRes.json(); sha = json.sha; }

      const putRes = await fetch(url, {
        method: 'PUT',
        headers: { 'Authorization': `token ${conf.token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: `Backup ${new Date().toLocaleString()}`, content: contentBase64, sha: sha })
      });

      if (putRes.ok) alert("âœ… í´ë¼ìš°ë“œ ë°±ì—… ì™„ë£Œ!");
      else alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + (await putRes.json()).message);
    } catch (e) { alert("ì˜¤ë¥˜ ë°œìƒ: " + e); }
  }

  async function loadFromGithub() {
    const conf = JSON.parse(localStorage.getItem('gh_config_fixer') || '{}');
    if(!conf.token) return alert('í† í° ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    
    const url = `https://api.github.com/repos/${conf.repo}/contents/${conf.path}`;
    try {
      const res = await fetch(url, { headers: { 'Authorization': `token ${conf.token}`, 'Accept': 'application/vnd.github.v3+json' } });
      if (!res.ok) throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      
      const data = await res.json();
      const decoded = decodeURIComponent(escape(atob(data.content)));
      const parsed = JSON.parse(decoded);

      // ë°ì´í„° ë¶„ë¦¬ ë³µì›
      if (parsed.codeDB) localStorage.setItem(DB_KEY_CODE, JSON.stringify(parsed.codeDB));
      if (parsed.nameDB) localStorage.setItem(DB_KEY_NAME, JSON.stringify(parsed.nameDB));
      
      alert("âœ… í´ë¼ìš°ë“œ ë°ì´í„° ë³µì› ì™„ë£Œ!");
      renderRuleList(); // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
    } catch (e) { alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e); }
  }
</script>

</body>
</html>
